## Secure QR Login Backend (Appwrite)

This project uses **Appwrite Cloud Functions** as a lightweight backend for a one‑way, QR‑based login flow. The frontend is already implemented; this document describes how to configure Appwrite and how the frontend should talk to the backend.

---

## 1. Appwrite database & collection

Create **one database** and **one collection** to store short‑lived login requests.

- **Database ID**: set and copy the ID into the `DB_ID` environment variable (e.g. name it `qr-login-db`).
- **Collection ID**: set and copy the ID into the `COLLECTION_ID` environment variable (e.g. name it `login_requests`).

### 1.1 Attributes

Create the following attributes on the collection (all required unless marked optional).

- **`username`**
  - Type: string
  - Size: enough for your usernames (e.g. 128)
  - Required: yes
  - Description: Identifier entered on the desktop login form.

- **`token`**
  - Type: string
  - Size: 64
  - Required: yes
  - Description: Random 24‑byte hex string generated by the backend for this login attempt.

- **`status`**
  - Type: enum
  - Values: `PENDING`, `APPROVED`, `DENIED`, `EXPIRED`
  - Required: yes
  - Default: `PENDING`

- **`createdAt`**
  - Type: integer
  - Required: yes
  - Description: Timestamp in milliseconds from `Date.now()` when the request was created.

- **`expiresAt`**
  - Type: integer
  - Required: yes
  - Description: `createdAt + LOGIN_REQUEST_TTL_MS` (typically 120000 ms = 2 minutes).

- **`approvedAt`** (optional)
  - Type: integer
  - Required: no
  - Description: Timestamp in milliseconds when the user APPROVED the login.

- **`deviceInfo`** (optional)
  - Type: string
  - Required: no
  - Description: User agent string of the device that approved/denied the login.

### 1.2 Indexes

Create these indexes on the collection:

- **Token lookup index**
  - Key: `token`
  - Type: key
  - Order: ascending
  - Unique: **true**
  - Used by the `decision` function to find a login request by token.

- **(Optional) Username + status index**
  - Keys: `username`, `status`
  - Type: composite
  - Order: ascending
  - Used to quickly find existing `PENDING` requests per user if you want to expire old ones when a new login is started.

---

## 2. Functions and environment variables

There are three Node.js Appwrite functions under the `functions/` directory:

- `functions/startLogin`
- `functions/decision`
- `functions/getStatus`

Configure the **same environment variables** for each function in the Appwrite console:

- **`APPWRITE_ENDPOINT`** – Your Appwrite endpoint URL.
- **`APPWRITE_PROJECT_ID`** – The Appwrite project ID.
- **`APPWRITE_API_KEY`** – API key with read/write access to the login database/collection.
- **`DB_ID`** – ID of the database created above.
- **`COLLECTION_ID`** – ID of the collection created above.
- **`FRONTEND_BASE_URL`** – Base URL of the deployed frontend, e.g. `https://example.com`.
- **`LOGIN_REQUEST_TTL_MS`** (optional) – Time‑to‑live for a login request in milliseconds. Defaults to **120000** (2 minutes) when not set.

All functions are written as ES modules and use the `node-appwrite` SDK.

---

## 3. Backend API contract (for the frontend)

### 3.1 Start login – `startLogin`

- **URL**: Appwrite function HTTP URL for `startLogin`.
- **Method**: `POST`
- **Request body (JSON)**:

```json
{
  "username": "alice"
}
```

- **Successful response (JSON)**:

```json
{
  "requestId": "LOGIN_REQUEST_DOCUMENT_ID",
  "approveUrl": "https://frontend.example.com/approve?token=abc123...",
  "qrUrl": "https://frontend.example.com/approve?token=abc123...",
  "expiresInSeconds": 120
}
```

- **Error response**:

```json
{ "error": "username is required" }
```

The desktop frontend should:

- Call this endpoint when the user submits their username.
- Render the returned `qrUrl` as a QR code.
- Optionally show `approveUrl` as a copyable link.
- Start polling `getStatus` using `requestId`.

### 3.2 Approve or deny login – `decision`

- **URL**: Appwrite function HTTP URL for `decision`.
- **Method**: `POST`
- **Request body (JSON)**:

```json
{
  "token": "abc123...",
  "decision": "APPROVED"
}
```

`decision` must be `"APPROVED"` or `"DENIED"`.

- **Successful response (JSON)**:

```json
{ "message": "Login approved" }
```

or

```json
{ "message": "Login denied" }
```

- **Other responses**:
  - `{ "error": "token is required" }`
  - `{ "error": "decision must be APPROVED or DENIED" }`
  - `{ "error": "invalid token" }`
  - `{ "message": "Session expired" }`
  - `{ "message": "Already APPROVED" }` (or `DENIED` / `EXPIRED`)

The **mobile approval page** (opened via the QR URL) should:

- Read the `token` from the query string (`/approve?token=...`).
- Let the user tap **Approve** or **Deny**.
- Call this endpoint with the selected `decision`.
- Show the response message on screen.

### 3.3 Check status – `getStatus`

- **URL**: Appwrite function HTTP URL for `getStatus`.
- **Methods**:
  - `GET` with `?requestId=...`
  - or `POST` with JSON body `{ "requestId": "..." }`

- **Successful response (JSON)**:

```json
{ "status": "PENDING" }
```

Status can be one of: `"PENDING"`, `"APPROVED"`, `"DENIED"`, `"EXPIRED"`.

- **Error responses**:
  - `{ "error": "requestId required" }`
  - `{ "error": "login request not found" }`

The **desktop frontend** should:

- Poll this endpoint every 1–3 seconds after calling `startLogin`.
- If status becomes `"APPROVED"`, treat the user as logged in and stop polling.
- If status becomes `"DENIED"` or `"EXPIRED"`, stop polling and show a message / allow retry.

---

## 4. Notes and recommendations

- Keep `LOGIN_REQUEST_TTL_MS` short (around 2 minutes) for security.
- Tokens are **single use**: once not `PENDING`, further approvals/denials on the same token are treated as no‑ops with a friendly message.
- You can later extend the collection with more audit fields (IP address, geo info, etc.) without changing the core flow.

